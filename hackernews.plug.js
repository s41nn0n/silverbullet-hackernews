var T=Object.defineProperty;var h=(e,t)=>{for(var n in t)T(e,n,{get:t[n],enumerable:!0})};var d=e=>{throw new Error("Not initialized yet")},y=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var g=new Map,f=0;y&&(globalThis.syscall=async(e,...t)=>await new Promise((n,o)=>{f++,g.set(f,{resolve:n,reject:o}),d({type:"sys",id:f,name:e,args:t})}));function x(e,t,n){y&&(d=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let s=e[i.name];if(!s)throw new Error(`Function not loaded: ${i.name}`);try{let a=await Promise.resolve(s(...i.args||[]));d({type:"invr",id:i.id,result:a})}catch(a){console.error("An exception was thrown as a result of invoking function",i.name,"error:",a.message),d({type:"invr",id:i.id,error:a.message})}}break;case"sysr":{let s=i.id,a=g.get(s);if(!a)throw Error("Invalid request id");g.delete(s),i.error?a.reject(new Error(i.error)):a.resolve(i.result)}break}})().catch(console.error)}),d({type:"manifest",manifest:t}))}function N(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function P(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function U(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?P(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function D(){globalThis.fetch=async function(e,t){let n=t&&t.body?P(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await U(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(o.base64Body?N(o.base64Body):null,{status:o.status,headers:o.headers})}}y&&D();var c={};h(c,{confirm:()=>ce,copyToClipboard:()=>Pe,deleteLine:()=>ve,dispatch:()=>se,downloadFile:()=>G,filterBox:()=>X,flashNotification:()=>J,fold:()=>me,foldAll:()=>fe,getCurrentPage:()=>R,getCursor:()=>K,getSelection:()=>q,getText:()=>E,getUiOption:()=>ue,goHistory:()=>z,hidePanel:()=>ee,insertAtCursor:()=>ie,insertAtPos:()=>te,moveCursor:()=>ne,moveCursorToLine:()=>oe,navigate:()=>B,openCommandPalette:()=>I,openPageNavigator:()=>j,openSearchPanel:()=>xe,openUrl:()=>V,prompt:()=>ae,redo:()=>he,reloadConfigAndCommands:()=>Q,reloadPage:()=>W,reloadUI:()=>O,replaceRange:()=>re,save:()=>L,setSelection:()=>_,setText:()=>H,setUiOption:()=>le,showPanel:()=>Z,toggleFold:()=>pe,undo:()=>ye,unfold:()=>de,unfoldAll:()=>ge,uploadFile:()=>Y,vimEx:()=>be});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function R(){return r("editor.getCurrentPage")}function E(){return r("editor.getText")}function H(e){return r("editor.setText",e)}function K(){return r("editor.getCursor")}function q(){return r("editor.getSelection")}function _(e,t){return r("editor.setSelection",e,t)}function L(){return r("editor.save")}function B(e,t=!1,n=!1){return r("editor.navigate",e,t,n)}function j(e="page"){return r("editor.openPageNavigator",e)}function I(){return r("editor.openCommandPalette")}function W(){return r("editor.reloadPage")}function O(){return r("editor.reloadUI")}function Q(){return r("editor.reloadConfigAndCommands")}function V(e,t=!1){return r("editor.openUrl",e,t)}function z(e){return r("editor.goHistory",e)}function G(e,t){return r("editor.downloadFile",e,t)}function Y(e,t){return r("editor.uploadFile",e,t)}function J(e,t="info"){return r("editor.flashNotification",e,t)}function X(e,t,n="",o=""){return r("editor.filterBox",e,t,n,o)}function Z(e,t,n,o=""){return r("editor.showPanel",e,t,n,o)}function ee(e){return r("editor.hidePanel",e)}function te(e,t){return r("editor.insertAtPos",e,t)}function re(e,t,n){return r("editor.replaceRange",e,t,n)}function ne(e,t=!1){return r("editor.moveCursor",e,t)}function oe(e,t=1,n=!1){return r("editor.moveCursorToLine",e,t,n)}function ie(e){return r("editor.insertAtCursor",e)}function se(e){return r("editor.dispatch",e)}function ae(e,t=""){return r("editor.prompt",e,t)}function ce(e){return r("editor.confirm",e)}function ue(e){return r("editor.getUiOption",e)}function le(e,t){return r("editor.setUiOption",e,t)}function me(){return r("editor.fold")}function de(){return r("editor.unfold")}function pe(){return r("editor.toggleFold")}function fe(){return r("editor.foldAll")}function ge(){return r("editor.unfoldAll")}function ye(){return r("editor.undo")}function he(){return r("editor.redo")}function xe(){return r("editor.openSearchPanel")}function Pe(e){return r("editor.copyToClipboard",e)}function ve(){return r("editor.deleteLine")}function be(e){return r("editor.vimEx",e)}var p={};h(p,{applyAttributeExtractors:()=>$e,getEnv:()=>De,getMode:()=>Re,getSpaceConfig:()=>Te,getVersion:()=>Ee,invokeCommand:()=>Ae,invokeFunction:()=>ke,invokeSpaceFunction:()=>Me,listCommands:()=>Se,listSyscalls:()=>Fe,reloadConfig:()=>Ue,reloadPlugs:()=>Ne});function ke(e,...t){return r("system.invokeFunction",e,...t)}function Ae(e,t){return r("system.invokeCommand",e,t)}function Se(){return r("system.listCommands")}function Fe(){return r("system.listSyscalls")}function Me(e,...t){return r("system.invokeSpaceFunction",e,...t)}function $e(e,t,n){return r("system.applyAttributeExtractors",e,t,n)}async function Te(e,t){return await r("system.getSpaceConfig",e)??t}function Ne(){return r("system.reloadPlugs")}function Ue(){return r("system.reloadConfig")}function De(){return r("system.getEnv")}function Re(){return r("system.getMode")}function Ee(){return r("system.getVersion")}async function v(){await c.hidePanel("lhs")}async function b(){let e=await c.prompt("Search Hacker News:");e&&await w(`https://hn.algolia.com/api/v1/search?query=${encodeURIComponent(e)}`,`Hacker News Results for "${e}"`,`\u{1F50D} HN ${e}`)}async function w(e,t,n){let o=await p.getSpaceConfig("hackernews"),i=o?.inline||!1,s=o?.panelType||"lhs",a=o?.baseOutPath||"";if(!e){await c.flashNotification("Unable to fetch empty URL");return}if(!t){await c.flashNotification("Unknown Page Title","error");return}if(!n){await c.flashNotification("Unknown File","error");return}try{let u=await Je(e);if(u.length===0){await c.flashNotification(`No results for ${t}`,"info");return}if(i){let l=Ye(u);a!=""&&!a.endsWith("/")?(n=`${a}${n}`,n=`${a}/${n}`):n=`${a}${n}`,await c.navigate({kind:"page",page:n}),await c.insertAtCursor(`
## ${t}
URI: [${e}](${e})
${l}
`)}else{let l=Ge(u),m=await c.getText();if(m){let $=m.split(`
`).length;await c.moveCursor($)}await c.showPanel(s,1,`<h1 onclick="syscall('system.invokeFunction', 'hackernews.hide');"> ${t} \u274C </h1> <br> <h2>URI</h2>: <a href="${e}">${e}</a> ${l}`)}await c.flashNotification(`${t} inserted!`,"info")}catch(u){return console.error("Error In searchAndSave:",u),await c.flashNotification(`Error getting ${t}!`,"error"),[]}}function Ge(e){return e.map(t=>`<br> <a href="${t.source_url}" target="_blank">\u{1F310} ${t.title} (${t.points} points)</a> - <a href="${t.url}" target="_blank">\u{1F4AC} (${t.comment_count} points)</a> `).join("<br>")}function Ye(e){return e.map(t=>`- [\u{1F310} ${t.title} (${t.points} points)](${t.source_url}) - [\u{1F4AC} (${t.comment_count} points)](${t.url})`).join(`
`)}async function Je(e){if(!e)return[];try{let n=await(await fetch(`${e}`)).json();return console.log(n),await c.flashNotification(`There are ${n.nbHits} hits`,"info"),n.hits.map(o=>({title:o.title,url:`https://news.ycombinator.com/item?id=${o.objectID}`,points:o.points,comment_count:o.num_comments,source_url:o.url}))}catch(t){return console.error("Error fetching Hacker News data:",t),[]}}async function C(){let e=new Date().toISOString().split("T")[0];await w("https://hn.algolia.com/api/v1/search_by_date?tags=front_page",`\u{1F3C6} Front Page ${e}`,"Front Page")}function Xe(e){if(!e)return null;console.log(e);let t={id:0,depth:1,children:-1},n=Number(e.trim());if(!isNaN(n))return t.id=n,t;let o=e.match(/id:\s*(\d+)/i),i=e.match(/depth:\s*(\d+)/i),s=e.match(/children:\s*(\d+)/i);return o&&(t.id=Number(o[1])),i&&(t.depth=Number(i[1])),s&&(t.children=Number(s[1])),t.depth>=1&&t.depth++,t.id?t:null}async function k(e,t=-1,n=-1){if(!e||n==0)return null;try{let o=n-1,s=await(await fetch(`https://hacker-news.firebaseio.com/v0/item/${e}.json`)).json();if(!s)return null;let a=[];if(s.kids){let u=t;for(let l of s.kids){if(u==0)break;u=u-1;let m=await k(l,u,o);m&&a.push(m)}}return{By:s.by,Text:s.text||"",Time:s.time,Kids:a,Parent:s.parent||"",ID:s.id}}catch(o){return console.error("Error fetching Hacker News data:",o),null}}async function A(e){if(!e)return{html:"",script:""};try{let t=Xe(e);if(!t)return{html:"<p>Invalid input format.</p>",script:""};let n=await k(t.id,t.children,t.depth);return console.log(n),n?{html:`
        <div class="hn-comments">
          ${S(n)}
        </div>
        <style>
          .hn-comments { font-family: Arial, sans-serif; max-width: 600px; }
          .comment { border-left: 2px solid #ccc; margin: 10px 0; padding: 10px; }
          .meta { font-size: 12px; color: #555; }
          .replies { margin-left: 20px; }
        </style>
      `,script:""}:{html:"<p>No comments found.</p>",script:""}}catch{return{html:"<p>Error loading comments.</p>",script:""}}}function S(e){return`
    <div class="comment">
      <p class="meta"><strong><a href="https://news.ycombinator.com/user?id=${e.By}" target="_blank">${e.By}</a></strong> - ${new Date(e.Time*1e3).toLocaleString()}</p>
      <p>${e.Text}</p>
      <div class="replies">
        ${e.Kids.map(S).join("")}
      </div>
    </div>
  `}var F={searchHackerNews:b,queryTopStories:C,hide:v,hackerNewsComment:A},M={name:"hackernews",version:"0.0.1",requiredPermissions:["fetch"],imports:["https://get.silverbullet.md/global.plug.json"],config:{"schema.config.properties":{maxResults:{type:null,nullable:!0,default:10},minPoints:{type:null,nullable:!0,default:10}}},functions:{searchHackerNews:{path:"hackernews.ts:searchHackerNews",command:{name:"HN Search"}},queryTopStories:{path:"hackernews.ts:frontPage",command:{name:"HN Front Page"}},hide:{path:"hackernews.ts:hide"},hackerNewsComment:{path:"./hackernews.ts:widget",codeWidget:"HN"}},assets:{}},Nt={manifest:M,functionMapping:F};x(F,M,self.postMessage);export{Nt as plug};
